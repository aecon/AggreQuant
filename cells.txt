NUCLEUS

1. Background subtraction
2. CLAHE
3. StarDist (Default parameters)
4. Keep only particles larger than some size:
    duplicate stardist result
    convert to mask
    analyse particles, keep only size>100, exclude on edges
    invert LUT (mask)
5. keep startdist labels only where there is positive mask:
    image calculator: AND (RESULT REUSES LABELS...... NEED TO DO IN PYTHON...)
    duplicate labels
    Find Edges
    Convert to mask: threshold > 0.1
    Edit -> Invert (Makes edges 0 and rest 1)
6. Image Calculator
    Get Min of Inverted edge mask and Nuclei Labels
    Convert to 8bit
    Run 1 Erode (Process -> Binary -> Erode)
    Analyse particles -> remove small crap (<100 pixel units). Actually remove even larger ones because usually smaller nuclei are errors in segmentation. Increase True Positives at the cost of increasing False Negatives.
    Invert LUT
// not needed: Run connected components to relabel
Now we have seeds ..
7. Invert seed mask (0 are cells) and compute Distance Map
// not needed: 8. Convert to 16bit
// not needed: 9. Equalize Histogram (Only normalize!)
8. Prepare for watershed: Normalize histogram (?) and Convert to 8bit
9. Use Watershed_ plugin from EPFL Biomedical Imaging Group to do watershed on grayscale values rather than distances. Store watershead boundary lines.
10. Erode wateshed lines!


CELL BOUNDARY SEGMENTATION

0. load original (cell boundary)
1. duplicate
    smooth: s=2
    CLAHE
    intensity mask using Minimum Error Auto-threshold
    => Now we have a mask of original cells in space.
2. duplicate original
    smooth: s=2
3. duplicate original
    smooth: s=20 --> background: want to remove bright intensities from nucleus
4. Image Calculator: divise s2 / s20
    CLAHE. (here intensity >0.6 shows definitely cells)

Alternative watershed field:
5a. Use last CLAHE'd image. Blur with sigma=6.
5. Convert to 16bit. Equalize Histogram (Only Normalize)
6. Convert to 8bit. Invert (Edit/Invert)
7. Make holes where there are nuclei:
    Image Calculator: inverted Nucleus mask AND Inverted CLAHE etc intensity filed from last step.
8. Do watershed on last field.
9. Clean up:
    Remove basins with no nucleus inside them.
    Remove areas that correspond to excluded nuclei
10. Erode wateshed Lines!!


BOTH

1. Combine Watershed boundary lines with cell intensity mask.
    Convert both to 8bit.
    Image Calculator: Take Min of the two images. Export NOT as 32-bit float.
2. Combine mask from previous step with nuclei mask.
    Image Calculator: Take Max (?) of the two images. Should add back to the cell boundary mask the areas occupied by the nuclei.



